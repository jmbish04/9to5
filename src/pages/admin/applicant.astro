---
import AdminLayout from '../../layouts/AdminLayout.astro';
// import { Textarea } from '../../components/ui/textarea';
// import { Input } from '../../components/ui/input';
import Button from '../../components/ui/button.astro';
import Card from '../../components/ui/card.astro';
import CardHeader from '../../components/ui/card-header.astro';
import CardTitle from '../../components/ui/card-title.astro';
import CardContent from '../../components/ui/card-content.astro';
import {
  getApplicantHistory,
  submitApplicantHistory,
  createCoverLetter,
  createResume
} from '../../lib/api';

const USER_ID = 'default-user';

// Load existing profile + history
const { data: histData, error: histErr } = await (async () => {
  try { return { data: await getApplicantHistory(USER_ID), error: null }; }
  catch (e) { return { data: null, error: e }; }
})();
---
<AdminLayout>
  <div class="grid grid-cols-1 gap-4 xl:grid-cols-2">

    <Card>
      <CardHeader><CardTitle>Applicant Profile & History</CardTitle></CardHeader>
      <CardContent>
        {
          histErr
            ? <div class="text-sm text-red-700">Failed to load applicant data.</div>
            : histData
              ? (
                <div class="space-y-6">
                  <div class="bg-neutral-50 rounded-lg p-4">
                    <div class="text-sm font-medium mb-2">Applicant Profile</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                      <div><span class="font-medium">Name:</span> {histData.applicant?.name || '—'}</div>
                      <div><span class="font-medium">Email:</span> {histData.applicant?.email || '—'}</div>
                      <div><span class="font-medium">Current Title:</span> {histData.applicant?.current_title || '—'}</div>
                      <div><span class="font-medium">Experience:</span> {histData.applicant?.years_experience ?? '—'} years</div>
                      <div><span class="font-medium">Remote Preference:</span> {histData.applicant?.preferences?.remote_preference || '—'}</div>
                      <div><span class="font-medium">Location:</span> {histData.applicant?.location || '—'}</div>
                    </div>
                    
                    {histData.applicant?.skills && histData.applicant.skills.length > 0 && (
                      <div class="mt-3">
                        <div class="text-xs font-medium mb-2">Skills</div>
                        <div class="flex flex-wrap gap-1">
                          {histData.applicant.skills.map((skill) => (
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-md">{skill}</span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>

                  <div>
                    <div class="mb-2 text-sm font-medium flex items-center justify-between">
                      <span>Job History</span>
                      {histData.job_history?.length > 0 && (
                        <span class="text-xs text-neutral-500">{histData.job_history.length} entries</span>
                      )}
                    </div>
                    {
                      (histData.job_history?.length ?? 0) === 0
                        ? <div class="text-sm text-neutral-500 text-center py-8 border rounded-lg bg-neutral-50">
                            No job history yet. Upload your resume or paste your work experience above.
                          </div>
                        : (
                          <div class="max-h-64 overflow-auto rounded border">
                            <table class="w-full text-sm">
                              <thead class="bg-neutral-50 text-neutral-600 sticky top-0">
                                <tr>
                                  <th class="px-3 py-2 text-left">Company</th>
                                  <th class="px-3 py-2 text-left">Title</th>
                                  <th class="px-3 py-2 text-left">Duration</th>
                                  <th class="px-3 py-2 text-left">Location</th>
                                </tr>
                              </thead>
                              <tbody class="divide-y">
                                {histData.job_history.map((h, index) => (
                                  <tr class={index % 2 === 0 ? 'bg-white' : 'bg-neutral-25'}>
                                    <td class="px-3 py-2 font-medium">{h.company_name || '—'}</td>
                                    <td class="px-3 py-2">{h.job_title || '—'}</td>
                                    <td class="px-3 py-2">
                                      <div class="text-xs">
                                        <div>{h.start_date || '—'} → {h.is_current ? 'Present' : (h.end_date || '—')}</div>
                                        {h.is_current && <span class="text-green-600 font-medium">Current</span>}
                                      </div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">{h.location || '—'}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        )
                    }
                  </div>

                  <div>
                    <div class="mb-2 text-sm font-medium flex items-center justify-between">
                      <span>Recent Submissions</span>
                      {histData.submissions?.length > 0 && (
                        <span class="text-xs text-neutral-500">{histData.submissions.length} total</span>
                      )}
                    </div>
                    {
                      (histData.submissions?.length ?? 0) === 0
                        ? <div class="text-sm text-neutral-500 text-center py-4 border rounded-lg bg-neutral-50">
                            No submissions recorded yet.
                          </div>
                        : (
                          <div class="space-y-2">
                            {histData.submissions.slice(0, 5).map((s, index) => (
                              <div class="flex items-center justify-between p-3 border rounded-lg bg-white">
                                <div class="flex-1">
                                  <div class="flex items-center gap-2">
                                    <span class={`px-2 py-1 rounded text-xs font-medium ${
                                      s.processing_status === 'completed' ? 'bg-green-100 text-green-800' :
                                      s.processing_status === 'failed' ? 'bg-red-100 text-red-800' :
                                      'bg-yellow-100 text-yellow-800'
                                    }`}>
                                      {s.processing_status}
                                    </span>
                                    {s.processed_entries != null && (
                                      <span class="text-xs text-neutral-600">{s.processed_entries} entries</span>
                                    )}
                                  </div>
                                  {s.processing_error && (
                                    <div class="text-xs text-red-600 mt-1">Error: {s.processing_error}</div>
                                  )}
                                </div>
                                <div class="text-xs text-neutral-500">
                                  {s.created_at ? new Date(s.created_at).toLocaleDateString() : '—'}
                                </div>
                              </div>
                            ))}
                            {histData.submissions.length > 5 && (
                              <div class="text-xs text-neutral-500 text-center py-2">
                                ... and {histData.submissions.length - 5} more submissions
                              </div>
                            )}
                          </div>
                        )
                    }
                  </div>
                </div>
              )
              : <div class="text-sm text-neutral-500">Loading…</div>
        }
      </CardContent>
    </Card>

    <Card>
      <CardHeader><CardTitle>Ingest Job History (Paste or Upload)</CardTitle></CardHeader>
      <CardContent>
        <div class="space-y-4">
          <div class="text-xs text-neutral-600">
            Paste plaintext, Markdown, or JSON. Or upload resume files (PDF, DOC, DOCX, TXT). The agent will parse and normalize it into entries.
          </div>
          
          {/* Text Input Section */}
          <div class="space-y-2">
            <label class="text-xs font-medium" for="historyContent">Content</label>
            <textarea
              id="historyContent"
              placeholder="Paste resume, markdown notes, bullets…"
              class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            ></textarea>
          </div>

          {/* File Upload Section */}
          <div class="space-y-2">
            <label class="text-xs font-medium">Or Upload File</label>
            <div class="border-2 border-dashed border-neutral-300 rounded-lg p-4 text-center">
              <input
                type="file"
                id="historyFile"
                accept=".pdf,.doc,.docx,.txt,.md"
                class="hidden"
                onChange={`
                  const file = event.target.files[0];
                  const label = document.getElementById('file-label');
                  if (file) {
                    label.textContent = 'File selected: ' + file.name;
                    // Clear textarea when file is selected
                    const t = document.getElementById('historyContent');
                    if (t) t.value = '';
                  } else {
                    label.textContent = 'Click to upload or drag and drop';
                  }
                `}
              />
              <label for="historyFile" id="file-label" class="cursor-pointer text-sm text-neutral-600 hover:text-neutral-800">
                Click to upload or drag and drop
              </label>
              <div class="text-xs text-neutral-500 mt-1">
                Supports PDF, DOC, DOCX, TXT, MD files
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <div class="mb-1 text-xs text-neutral-600">Content Type</div>
              <select id="historyType" class="h-9 w-full rounded-md border border-neutral-300 px-3 text-sm">
                <option value="text/plain">text/plain</option>
                <option value="text/markdown">text/markdown</option>
                <option value="application/json">application/json</option>
                <option value="application/pdf">PDF (upload only)</option>
                <option value="application/msword">DOC (upload only)</option>
              </select>
            </div>
            <div class="flex items-end justify-end">
              <Button
                client:only="react"
                onClick={async () => {
                  const textContent = (document.getElementById('historyContent') as HTMLTextAreaElement)?.value || '';
                  const fileInput = document.getElementById('historyFile') as HTMLInputElement | null;
                  const file = fileInput?.files?.[0];
                  const contentType = (document.getElementById('historyType') as HTMLSelectElement).value as any;
                  
                  let content = '';
                  let finalContentType = contentType;
                  
                  if (file) {
                    try {
                      if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                        const reader = new FileReader();
                        content = await new Promise((resolve, reject) => {
                          reader.onload = () => resolve(reader.result as string);
                          reader.onerror = reject;
                          reader.readAsDataURL(file);
                        });
                        finalContentType = 'application/pdf';
                      } else {
                        const reader = new FileReader();
                        content = await new Promise((resolve, reject) => {
                          reader.onload = () => resolve(reader.result as string);
                          reader.onerror = reject;
                          reader.readAsText(file);
                        });
                        if (file.name.endsWith('.md')) finalContentType = 'text/markdown';
                        else if (file.name.endsWith('.json')) finalContentType = 'application/json';
                        else finalContentType = 'text/plain';
                      }
                    } catch (e) {
                      alert('Error reading file. Please try again.');
                      return;
                    }
                  } else if (textContent.trim()) {
                    content = textContent;
                  } else {
                    alert('Please provide content by pasting text or uploading a file.');
                    return;
                  }
                  
                  try {
                    const res = await submitApplicantHistory({ 
                      user_id: 'default-user', 
                      raw_content: content, 
                      content_type: finalContentType 
                    });
                    alert(\`Submitted successfully! Entries processed: \${res.entries_processed ?? 0}\`);
                    location.reload();
                  } catch (e) {
                    alert('Failed to submit history. Please check the content and try again.');
                    console.error('Submission error:', e);
                  }
                }}
              >Submit</Button>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>

    <Card class="xl:col-span-2">
      <CardHeader><CardTitle>AI Tools: Cover Letter & Resume</CardTitle></CardHeader>
      <CardContent>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <section class="space-y-2">
            <div class="text-sm font-medium">Cover Letter</div>
            <label class="text-xs">Job Title</label>
            <input type="text" id="cl_job_title" placeholder="Head of Data" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Company Name</label>
            <input type="text" id="cl_company_name" placeholder="Acme Corp" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Hiring Manager (optional)</label>
            <input type="text" id="cl_hm" placeholder="Jane Doe" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Job Description (paste)</label>
            <textarea id="cl_jd" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <label class="text-xs">Your Career Summary</label>
            <textarea id="cl_summary" placeholder="2–3 paragraphs or bullets summarizing your background" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <div class="flex gap-2">
              <Button
                client:only="react"
                onClick={async () => {
                  const b = {
                    job_title: (document.getElementById('cl_job_title') as HTMLInputElement).value,
                    company_name: (document.getElementById('cl_company_name') as HTMLInputElement).value,
                    hiring_manager_name: (document.getElementById('cl_hm') as HTMLInputElement).value || undefined,
                    job_description_text: (document.getElementById('cl_jd') as HTMLTextAreaElement).value,
                    candidate_career_summary: (document.getElementById('cl_summary') as HTMLTextAreaElement).value
                  };
                  if (!b.job_title || !b.company_name || !b.job_description_text || !b.candidate_career_summary) {
                    alert('Fill required fields.'); return;
                  }
                  try {
                    const res = await createCoverLetter(b);
                    const out = res.html || `<pre>${res.cover_letter}</pre>`;
                    const el = document.getElementById('cl_output')!;
                    el.innerHTML = out;
                    el.scrollIntoView({ behavior: 'smooth' });
                  } catch {
                    alert('Failed to generate cover letter.');
                  }
                }}
              >Generate</Button>
              <Button
                variant="secondary"
                client:only="react"
                onClick={() => {
                  const el = document.getElementById('cl_output');
                  if (!el) return;
                  const range = document.createRange();
                  range.selectNode(el);
                  const sel = window.getSelection();
                  sel?.removeAllRanges();
                  sel?.addRange(range);
                  document.execCommand('copy');
                  sel?.removeAllRanges();
                  alert('Copied cover letter to clipboard.');
                }}
              >Copy</Button>
              <Button
                variant="outline"
                client:only="react"
                onClick={() => {
                  const el = document.getElementById('cl_output');
                  if (!el || !el.innerHTML.trim()) {
                    alert('Please generate a cover letter first.');
                    return;
                  }
                  
                  const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>Cover Letter</title>
                      <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
                        .prose { color: #333; }
                        .prose p { margin-bottom: 1em; }
                        .prose h1, .prose h2, .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; }
                        @media print { body { margin: 0; padding: 20px; } }
                      </style>
                    </head>
                    <body>
                      <div class="prose">${el.innerHTML}</div>
                    </body>
                    </html>
                  `;
                  
                  const printWindow = window.open('', '_blank');
                  printWindow?.document.write(printContent);
                  printWindow?.document.close();
                  printWindow?.print();
                }}
              >Print/PDF</Button>
            </div>
            <div id="cl_output" class="prose mt-2 max-w-none rounded border p-3 text-sm"></div>
          </section>

          <section class="space-y-2">
            <div class="text-sm font-medium">Resume Optimizer</div>
            <label class="text-xs">Job Title</label>
            <input type="text" id="re_job_title" placeholder="Head of Data" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Company Name</label>
            <input type="text" id="re_company_name" placeholder="Acme Corp" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Job Description (paste)</label>
            <textarea id="re_jd" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <label class="text-xs">Your Career Summary</label>
            <textarea id="re_summary" placeholder="Key highlights to emphasize" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <div class="flex gap-2">
              <Button
                client:only="react"
                onClick={async () => {
                  const b = {
                    job_title: (document.getElementById('re_job_title') as HTMLInputElement).value,
                    company_name: (document.getElementById('re_company_name') as HTMLInputElement).value,
                    job_description_text: (document.getElementById('re_jd') as HTMLTextAreaElement).value,
                    candidate_career_summary: (document.getElementById('re_summary') as HTMLTextAreaElement).value
                  };
                  if (!b.job_title || !b.company_name || !b.job_description_text || !b.candidate_career_summary) {
                    alert('Fill required fields.'); return;
                  }
                  try {
                    const res = await createResume(b);
                    const html = `
                      <div class="space-y-3">
                        <div><span class="font-medium">Summary:</span><div class="mt-1">${res.summary || ''}</div></div>
                        <div><span class="font-medium">Experience Bullets:</span><ul class="list-disc pl-5">${(res.experience_bullets||[]).map((x)=>`<li>${x}</li>`).join('')}</ul></div>
                        <div><span class="font-medium">Skills:</span><div class="mt-1">${(res.skills||[]).join(', ')}</div></div>
                      </div>
                    `;
                    const el = document.getElementById('re_output')!;
                    el.innerHTML = html;
                    el.scrollIntoView({ behavior: 'smooth' });
                  } catch {
                    alert('Failed to generate resume content.');
                  }
                }}
              >Generate</Button>
              <Button
                variant="secondary"
                client:only="react"
                onClick={() => {
                  const el = document.getElementById('re_output');
                  if (!el) return;
                  const range = document.createRange();
                  range.selectNode(el);
                  const sel = window.getSelection();
                  sel?.removeAllRanges();
                  sel?.addRange(range);
                  document.execCommand('copy');
                  sel?.removeAllRanges();
                  alert('Copied resume content to clipboard.');
                }}
              >Copy</Button>
              <Button
                variant="outline"
                client:only="react"
                onClick={() => {
                  const el = document.getElementById('re_output');
                  if (!el || !el.innerHTML.trim()) {
                    alert('Please generate resume content first.');
                    return;
                  }
                  
                  const printContent = \`
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>Resume Content</title>
                      <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
                        .space-y-3 > * + * { margin-top: 1rem; }
                        .font-medium { font-weight: 500; }
                        .list-disc { list-style-type: disc; }
                        .pl-5 { padding-left: 1.25rem; }
                        .mt-1 { margin-top: 0.25rem; }
                        li { margin-bottom: 0.5rem; }
                        @media print { body { margin: 0; padding: 20px; } }
                      </style>
                    </head>
                    <body>
                      <div>\${el.innerHTML}</div>
                    </body>
                    </html>
                  \`;
                  
                  const printWindow = window.open('', '_blank');
                  printWindow?.document.write(printContent);
                  printWindow?.document.close();
                  printWindow?.print();
                }}
              >Print/PDF</Button>
            </div>
            <div id="re_output" class="prose mt-2 max-w-none rounded border p-3 text-sm"></div>
          </section>
        </div>
      </CardContent>
    </Card>

  </div>
</AdminLayout>