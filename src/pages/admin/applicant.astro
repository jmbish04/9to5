---
import AdminLayout from '../../layouts/AdminLayout.astro';
// import { Textarea } from '../../components/ui/textarea';
// import { Input } from '../../components/ui/input';
import Button from '../../components/ui/button.astro';
import Card from '../../components/ui/card.astro';
import CardHeader from '../../components/ui/card-header.astro';
import CardTitle from '../../components/ui/card-title.astro';
import CardContent from '../../components/ui/card-content.astro';
import {
  getApplicantHistory,
  submitApplicantHistory,
  createCoverLetter,
  createResume
} from '../../lib/api';

const USER_ID = 'default-user';

// Load existing profile + history
const { data: histData, error: histErr } = await (async () => {
  try { return { data: await getApplicantHistory(USER_ID), error: null }; }
  catch (e) { return { data: null, error: e }; }
})();
---
<AdminLayout>
  <div class="grid grid-cols-1 gap-4 xl:grid-cols-2">

    <Card>
      <CardHeader><CardTitle>Applicant Profile & History</CardTitle></CardHeader>
      <CardContent>
        {
          histErr
            ? <div class="text-sm text-red-700">Failed to load applicant data.</div>
            : histData
              ? (
                <div class="space-y-4">
                  <div class="text-sm">
                    <div><span class="font-medium">User:</span> {histData.applicant?.name || '—'} ({histData.applicant?.email || '—'})</div>
                    <div class="text-neutral-600 text-xs">
                      Title: {histData.applicant?.current_title || '—'} ·
                      Experience: {histData.applicant?.years_experience ?? '—'} yrs ·
                      Pref Remote: {histData.applicant?.preferences?.remote_preference || '—'}
                    </div>
                  </div>

                  <div>
                    <div class="mb-1 text-xs font-medium">Job History</div>
                    {
                      (histData.job_history?.length ?? 0) === 0
                        ? <div class="text-sm text-neutral-500">No history yet.</div>
                        : (
                          <div class="max-h-56 overflow-auto rounded border">
                            <table class="w-full text-sm">
                              <thead class="bg-neutral-50 text-neutral-600">
                                <tr>
                                  <th class="px-3 py-2 text-left">Company</th>
                                  <th class="px-3 py-2 text-left">Title</th>
                                  <th class="px-3 py-2 text-left">Dates</th>
                                  <th class="px-3 py-2 text-left">Location</th>
                                </tr>
                              </thead>
                              <tbody class="divide-y">
                                {histData.job_history.map((h) => (
                                  <tr>
                                    <td class="px-3 py-2">{h.company_name || '—'}</td>
                                    <td class="px-3 py-2">{h.job_title || '—'}</td>
                                    <td class="px-3 py-2">
                                      {h.start_date || '—'} → {h.is_current ? 'Present' : (h.end_date || '—')}
                                    </td>
                                    <td class="px-3 py-2">{h.location || '—'}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        )
                    }
                  </div>

                  <div>
                    <div class="mb-1 text-xs font-medium">Recent Submissions</div>
                    {
                      (histData.submissions?.length ?? 0) === 0
                        ? <div class="text-sm text-neutral-500">No submissions recorded.</div>
                        : (
                          <ul class="text-xs">
                            {histData.submissions.slice(0, 5).map((s) => (
                              <li class="mb-1">
                                <span class="font-medium">{s.processing_status}</span>
                                {s.processed_entries != null ? ` · entries: ${s.processed_entries}` : ''}
                                {s.processing_error ? ` · error: ${s.processing_error}` : ''}
                              </li>
                            ))}
                          </ul>
                        )
                    }
                  </div>
                </div>
              )
              : <div class="text-sm text-neutral-500">Loading…</div>
        }
      </CardContent>
    </Card>

    <Card>
      <CardHeader><CardTitle>Ingest Job History (Paste anything)</CardTitle></CardHeader>
      <CardContent>
        <div class="space-y-2">
          <div class="text-xs text-neutral-600">
            Paste plaintext, Markdown, or JSON. The agent will parse and normalize it into entries.
          </div>
          <label class="text-xs font-medium">Content</label>
          <textarea id="historyContent" placeholder="Paste resume, markdown notes, bullets…" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <div class="mb-1 text-xs text-neutral-600">Content Type</div>
              <select id="historyType" class="h-9 w-full rounded-md border border-neutral-300 px-3 text-sm">
                <option value="text/plain">text/plain</option>
                <option value="text/markdown">text/markdown</option>
                <option value="application/json">application/json</option>
              </select>
            </div>
            <div class="flex items-end justify-end">
              <Button disabled>Submit History</Button>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>

    <Card class="xl:col-span-2">
      <CardHeader><CardTitle>AI Tools: Cover Letter & Resume</CardTitle></CardHeader>
      <CardContent>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <section class="space-y-2">
            <div class="text-sm font-medium">Cover Letter</div>
            <label class="text-xs">Job Title</label>
            <input type="text" id="cl_job_title" placeholder="Head of Data" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Company Name</label>
            <input type="text" id="cl_company_name" placeholder="Acme Corp" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Hiring Manager (optional)</label>
            <input type="text" id="cl_hm" placeholder="Jane Doe" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Job Description (paste)</label>
            <textarea id="cl_jd" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <label class="text-xs">Your Career Summary</label>
            <textarea id="cl_summary" placeholder="2–3 paragraphs or bullets summarizing your background" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <div class="flex gap-2">
              <Button disabled>Generate Cover Letter</Button>
              <Button variant="secondary" disabled>Copy</Button>
            </div>
            <div id="cl_output" class="prose mt-2 max-w-none rounded border p-3 text-sm"></div>
          </section>

          <section class="space-y-2">
            <div class="text-sm font-medium">Resume Optimizer</div>
            <label class="text-xs">Job Title</label>
            <input type="text" id="re_job_title" placeholder="Head of Data" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Company Name</label>
            <input type="text" id="re_company_name" placeholder="Acme Corp" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <label class="text-xs">Job Description (paste)</label>
            <textarea id="re_jd" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <label class="text-xs">Your Career Summary</label>
            <textarea id="re_summary" placeholder="Key highlights to emphasize" class="w-full h-32 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <div class="flex gap-2">
              <Button disabled>Generate Resume</Button>
              <Button variant="secondary" disabled>Copy</Button>
            </div>
            <div id="re_output" class="prose mt-2 max-w-none rounded border p-3 text-sm"></div>
          </section>
        </div>
      </CardContent>
    </Card>

  </div>
</AdminLayout>
