---
import AdminLayout from '../../layouts/AdminLayout.astro';

// Pass the API token to the client-side components
const clientApiToken = import.meta.env.API_TOKEN || 'devtoken_1234';
---
<AdminLayout>
Â  <div class="mb-6">
Â  Â  <h1 class="text-2xl font-bold text-gray-900">Discovery Dashboard</h1>
Â  Â  <p class="mt-1 text-sm text-gray-600">
Â  Â  Â  Control job discovery, monitor tracking queue, and manage your job interests
Â  Â  </p>
Â  </div>

Â  <div class="grid gap-6 lg:grid-cols-2">
Â  Â  <!-- Discovery Controls -->
Â  Â  <div class="rounded-lg border border-gray-200 bg-white p-4">
Â  Â  Â  <h3 class="mb-3 text-lg font-semibold">Discovery & Monitoring Controls</h3>
Â  Â  Â Â 
Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  <!-- Discovery Controls -->
Â  Â  Â  Â  <div class="flex items-center justify-between p-3 border rounded-lg">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h4 class="font-medium text-sm">Job Discovery</h4>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-600">Find new job opportunities</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  onclick="startDiscovery()"
Â  Â  Â  Â  Â  Â  class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
Â  Â  Â  Â  Â  Â  id="discovery-btn"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Start Discovery
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Monitoring Controls -->
Â  Â  Â  Â  <div class="flex items-center justify-between p-3 border rounded-lg">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h4 class="font-medium text-sm">Job Monitoring</h4>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-600">Check existing jobs for changes</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  onclick="startMonitoring()"
Â  Â  Â  Â  Â  Â  class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 disabled:opacity-50"
Â  Â  Â  Â  Â  Â  id="monitoring-btn"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Start Monitoring
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Results Display -->
Â  Â  Â  Â  <div id="results-display" class="hidden"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Interest Signals Summary -->
Â  Â  <div class="rounded-lg border border-gray-200 bg-white p-4">
Â  Â  Â  <h3 class="mb-3 text-lg font-semibold">Interest Tracking</h3>
Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  <div class="text-sm text-gray-600">
Â  Â  Â  Â  Â  Track your interest in jobs locally. Signals are stored in your browser and can be synced later.
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="grid grid-cols-2 gap-4 p-3 bg-gray-50 rounded-lg">
Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  <div class="text-lg font-semibold text-green-700" id="interested-count">-</div>
Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-600">Interested</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  <div class="text-lg font-semibold text-gray-700" id="not-now-count">-</div>
Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-600">Not Now</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="text-xs text-gray-500">
Â  Â  Â  Â  Â  ðŸ’¡ Use the interest buttons on job listings to track your preferences
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <!-- Monitoring Queue - Full Width -->
Â  <div class="mt-6 rounded-lg border border-gray-200 bg-white p-4">
Â  Â  <div class="flex items-center justify-between mb-4">
Â  Â  Â  <h3 class="text-lg font-semibold">Monitoring Queue</h3>
Â  Â  Â  <button
Â  Â  Â  Â  onclick="loadQueue()"
Â  Â  Â  Â  class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50"
Â  Â  Â  Â  id="refresh-btn"
Â  Â  Â  >
Â  Â  Â  Â  Refresh
Â  Â  Â  </button>
Â  Â  </div>
Â  Â  <div id="queue-container">
Â  Â  Â  <div class="text-center text-gray-500 py-6">
Â  Â  Â  Â  <div class="text-sm">Loading queue...</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script define:vars={{ clientApiToken }}>
Â  Â  // Global state
Â  Â  let isLoading = false;

Â  Â  // Discovery functions
Â  Â  async function startDiscovery() {
Â  Â  Â  const btn = document.getElementById('discovery-btn');
Â  Â  Â  btn.disabled = true;
Â  Â  Â  btn.textContent = 'Running...';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch('/api/runs/discovery', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${clientApiToken}`
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  body: JSON.stringify({})
Â  Â  Â  Â  });

Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  showResult('discovery', result, response.ok);
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showResult('discovery', { error: error.message }, false);
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.textContent = 'Start Discovery';
Â  Â  Â  }
Â  Â  }

Â  Â  async function startMonitoring() {
Â  Â  Â  const btn = document.getElementById('monitoring-btn');
Â  Â  Â  btn.disabled = true;
Â  Â  Â  btn.textContent = 'Running...';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch('/api/runs/monitor', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${clientApiToken}`
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  showResult('monitoring', result, response.ok);
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showResult('monitoring', { error: error.message }, false);
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.textContent = 'Start Monitoring';
Â  Â  Â  }
Â  Â  }

Â  Â  function showResult(type, result, success) {
Â  Â  Â  const container = document.getElementById('results-display');
Â  Â  Â  const bgColor = success ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700';
Â  Â  Â Â 
Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="text-xs p-2 rounded border ${bgColor}">
Â  Â  Â  Â  Â  <div class="font-medium">${type} ${success ? 'started' : 'failed'}</div>
Â  Â  Â  Â  Â  ${result.run_id ? `<div>Run ID: ${result.run_id}</div>` : ''}
Â  Â  Â  Â  Â  ${result.status ? `<div>Status: ${result.status}</div>` : ''}
Â  Â  Â  Â  Â  ${result.error ? `<div>Error: ${result.error}</div>` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  container.classList.remove('hidden');
Â  Â  }

Â  Â  // Queue functions
Â  Â  async function loadQueue() {
Â  Â  Â  const container = document.getElementById('queue-container');
Â  Â  Â  const btn = document.getElementById('refresh-btn');
Â  Â  Â Â 
Â  Â  Â  btn.disabled = true;
Â  Â  Â  btn.textContent = 'Loading...';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch('/api/jobs/monitoring-queue?limit=20', {
Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${clientApiToken}`
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  renderQueue(data);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  throw new Error(data.error || 'Failed to load queue');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  <div class="text-center text-red-600 py-6">
Â  Â  Â  Â  Â  Â  <div class="text-sm">Failed to load queue: ${error.message}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.textContent = 'Refresh';
Â  Â  Â  }
Â  Â  }

Â  Â  function renderQueue(data) {
Â  Â  Â  const container = document.getElementById('queue-container');
Â  Â  Â Â 
Â  Â  Â  if (!data.jobs || data.jobs.length === 0) {
Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  <div class="text-center text-gray-500 py-6">
Â  Â  Â  Â  Â  Â  <div class="text-sm">No jobs in monitoring queue</div>
Â  Â  Â  Â  Â  Â  <div class="text-xs mt-1">All jobs are up to date</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const jobsHtml = data.jobs.map(job => {
Â  Â  Â  Â  const priorityBadge = job.monitoring_priority >= 8 ?Â 
Â  Â  Â  Â  Â  '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">High</span>' :
Â  Â  Â  Â  Â  job.monitoring_priority >= 5 ?
Â  Â  Â  Â  Â  '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Medium</span>' :
Â  Â  Â  Â  Â  '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">Low</span>';

Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  <div class="border rounded-lg p-3 hover:bg-gray-50">
Â  Â  Â  Â  Â  Â  <div class="flex items-start justify-between">
Â  Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-medium text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="/admin/jobs/${encodeURIComponent(job.id)}" class="text-blue-600 hover:underline">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${job.title || 'Untitled Job'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${priorityBadge}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-600 space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>${job.company || 'â€”'} â€¢ ${job.location || 'â€”'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>Last checked: ${job.days_since_last_check} days ago</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <a href="${job.url}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:underline ml-2">
Â  Â  Â  Â  Â  Â  Â  Â  View Job â†—
Â  Â  Â  _1  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  }).join('');

Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  <div class="text-sm text-gray-600 mb-4">
Â  Â  Â  Â  Â  ${data.total_jobs} jobs need monitoring, showing ${data.returned_jobs}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  ${jobsHtml}
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  }

Â  Â  // Interest counts functions
Â  Â  function updateInterestCounts() {
Â  Â  Â  try {
Â  Â  Â  Â  const signals = JSON.parse(localStorage.getItem('job_interest_signals') || '{}');
Â  Â  Â  Â  let interestedCount = 0;
Â  Â  Â  Â  let notNowCount = 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Object.values(signals).forEach((signal) => {
Â  Â  Â  Â  Â  if (signal.signal === 'interested') interestedCount++;
Â  Â  Â  Â  Â  if (signal.signal === 'not_now') notNowCount++;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('interested-count').textContent = interestedCount;
Â  Â  Â  Â  document.getElementById('not-now-count').textContent = notNowCount;
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Failed to update interest counts:', error);
Â  Â  Â  Â  document.getElementById('interested-count').textContent = '0';
Â  Â  Â  Â  document.getElementById('not-now-count').textContent = '0';
Â  Â  Â  }
Â  Â  }

Â  Â  // Initialize
Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  updateInterestCounts();
Â  Â  Â  loadQueue();
Â  Â  Â Â 
Â  Â  Â  // Listen for interest signal changes
Â  Â  Â  window.addEventListener('interestSignalChanged', updateInterestCounts);
Â  Â  });
Â  </script>
</AdminLayout>